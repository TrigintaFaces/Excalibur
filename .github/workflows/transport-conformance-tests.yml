name: Transport Conformance Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/Dispatch/Dispatch.Transport.*/**'
      - 'tests/conformance/**'
      - '.github/workflows/transport-conformance-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/Dispatch/Dispatch.Transport.*/**'
      - 'tests/conformance/**'
      - '.github/workflows/transport-conformance-tests.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  conformance-matrix:
    name: ${{ matrix.transport }} Conformance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        transport:
          - InMemory
          # - AzureServiceBus
          # - AwsSqs
          # - Kafka
          # - RabbitMq
          # - GooglePubSub

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Restore dependencies
        run: dotnet restore tests/conformance/Dispatch.Tests.Conformance/Dispatch.Tests.Conformance.csproj

      - name: Build conformance tests
        run: |
          dotnet build tests/conformance/Dispatch.Tests.Conformance/Dispatch.Tests.Conformance.csproj \
            --configuration Release \
            --no-restore \
            --verbosity normal

      - name: Run ${{ matrix.transport }} conformance tests
        run: |
          dotnet test tests/conformance/Dispatch.Tests.Conformance/Dispatch.Tests.Conformance.csproj \
            --configuration Release \
            --no-build \
            --no-restore \
            --filter "FullyQualifiedName~${{ matrix.transport }}TransportConformanceTests" \
            --verbosity normal \
            --logger "trx;LogFileName=${{ matrix.transport }}-conformance-results.trx" \
            --logger "console;verbosity=detailed" \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.transport }}-conformance-test-results
          path: |
            **/*-conformance-results.trx
            **/TestResults/**/*.xml
            **/TestResults/**/*.coverage
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: '**/TestResults/**/coverage.opencover.xml'
          flags: conformance,${{ matrix.transport }}
          name: ${{ matrix.transport }}-conformance-coverage

      - name: Generate conformance report
        if: always()
        run: |
          echo "## ${{ matrix.transport }} Transport Conformance Report" > conformance-report.md
          echo "" >> conformance-report.md
          echo "**Status:** ${{ job.status }}" >> conformance-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> conformance-report.md
          echo "" >> conformance-report.md
          echo "### Test Execution Summary" >> conformance-report.md
          dotnet test tests/conformance/Dispatch.Tests.Conformance/Dispatch.Tests.Conformance.csproj \
            --filter "FullyQualifiedName~${{ matrix.transport }}TransportConformanceTests" \
            --list-tests --verbosity quiet || true

      - name: Upload conformance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.transport }}-conformance-report
          path: conformance-report.md
          retention-days: 90

  conformance-summary:
    name: Conformance Test Summary
    runs-on: ubuntu-latest
    needs: conformance-matrix
    if: always()

    steps:
      - name: Download all conformance reports
        uses: actions/download-artifact@v4
        with:
          pattern: '*-conformance-report'
          path: reports/

      - name: Generate summary report
        run: |
          echo "# Transport Conformance Test Summary" > summary.md
          echo "" >> summary.md
          echo "**Run Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> summary.md
          echo "**Commit:** ${{ github.sha }}" >> summary.md
          echo "" >> summary.md
          echo "| Transport | Status | Report |" >> summary.md
          echo "|-----------|--------|--------|" >> summary.md

          for report in reports/*-conformance-report/*.md; do
            if [ -f "$report" ]; then
              transport=$(basename $(dirname "$report") | sed 's/-conformance-report//')
              status=$(grep "Status:" "$report" | cut -d ':' -f 2 | xargs || echo "Unknown")
              echo "| $transport | $status | [View](./$(basename $(dirname "$report"))/conformance-report.md) |" >> summary.md
            fi
          done

          cat summary.md

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: conformance-summary
          path: summary.md
          retention-days: 90

      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  conformance-gate:
    name: Conformance Gate
    runs-on: ubuntu-latest
    needs: conformance-matrix
    if: always()

    steps:
      - name: Check conformance test results
        run: |
          if [ "${{ needs.conformance-matrix.result }}" != "success" ]; then
            echo "❌ Conformance tests failed!"
            echo "At least one transport failed conformance testing."
            echo "Review the test results and fix failing transports before merging."
            exit 1
          else
            echo "✅ All conformance tests passed!"
            echo "All transports are compliant with the Dispatch transport contract."
          fi
