// SPDX-FileCopyrightText: Copyright (c) 2026 The Excalibur Project
// SPDX-License-Identifier: LicenseRef-Excalibur-1.0 OR AGPL-3.0-or-later OR SSPL-1.0 OR Apache-2.0

using Excalibur.Dispatch.Compliance;

using Excalibur.Testing.Conformance;

using Microsoft.Extensions.Logging.Abstractions;

using Xunit;

namespace Excalibur.Tests.Testing.Conformance;

/// <summary>
/// Conformance tests for <see cref="AesGcmEncryptionProvider"/> validating IEncryptionProvider contract compliance.
/// </summary>
/// <remarks>
/// <para>
/// AesGcmEncryptionProvider requires IKeyManagementProvider (InMemoryKeyManagementProvider) for key material.
/// Tests configure AutoGenerateDefaultKey = false for isolation.
/// </para>
/// <para>
/// <strong>COMPLIANCE-CRITICAL:</strong> IEncryptionProvider implements field-level encryption
/// per ADR-051 (Encryption Framework) with AES-256-GCM authenticated encryption.
/// </para>
/// <para>
/// Key behaviors verified:
/// <list type="bullet">
/// <item><description>EncryptAsync throws ArgumentNullException on null plaintext</description></item>
/// <item><description>EncryptAsync populates all required EncryptedData metadata</description></item>
/// <item><description>EncryptAsync throws when no active key or key is DecryptOnly</description></item>
/// <item><description>DecryptAsync throws ArgumentNullException on null encryptedData</description></item>
/// <item><description>DecryptAsync throws for unsupported algorithm, suspended key, non-existent key</description></item>
/// <item><description>Round-trip encryption/decryption returns original plaintext</description></item>
/// <item><description>Decrypt works after key rotation (DecryptOnly version)</description></item>
/// <item><description>ValidateFipsComplianceAsync returns boolean (environment-dependent)</description></item>
/// <item><description>Disposed provider throws ObjectDisposedException</description></item>
/// </list>
/// </para>
/// </remarks>
[System.Diagnostics.CodeAnalysis.SuppressMessage("Naming", "CA1707:Identifiers should not contain underscores", Justification = "Test method naming convention")]
[Trait("Category", "Integration")]
[Trait("Component", "Compliance")]
[Trait("Pattern", "PROVIDER")]
public class AesGcmEncryptionProviderConformanceTests : EncryptionProviderConformanceTestKit
{
	/// <inheritdoc />
	protected override async Task<(IEncryptionProvider Provider, IKeyManagementProvider KeyManagement)> CreateProviderAsync()
	{
		var keyManagement = new InMemoryKeyManagementProvider(
			NullLogger<InMemoryKeyManagementProvider>.Instance,
			new InMemoryKeyManagementOptions { AutoGenerateDefaultKey = false });

		var provider = new AesGcmEncryptionProvider(
			keyManagement,
			NullLogger<AesGcmEncryptionProvider>.Instance,
			new AesGcmEncryptionOptions());

		await Task.CompletedTask.ConfigureAwait(false); // Satisfy async requirement
		return (provider, keyManagement);
	}

	#region Encrypt Tests

	[Fact]
	public Task EncryptAsync_NullPlaintext_ShouldThrowArgumentNullException_Test() =>
		EncryptAsync_NullPlaintext_ShouldThrowArgumentNullException();

	[Fact]
	public Task EncryptAsync_ShouldPopulateEncryptedDataMetadata_Test() =>
		EncryptAsync_ShouldPopulateEncryptedDataMetadata();

	[Fact]
	public Task EncryptAsync_NoActiveKey_ShouldThrowEncryptionException_Test() =>
		EncryptAsync_NoActiveKey_ShouldThrowEncryptionException();

	[Fact]
	public Task EncryptAsync_DecryptOnlyKey_ShouldThrowEncryptionException_Test() =>
		EncryptAsync_DecryptOnlyKey_ShouldThrowEncryptionException();

	#endregion Encrypt Tests

	#region Decrypt Tests

	[Fact]
	public Task DecryptAsync_NullEncryptedData_ShouldThrowArgumentNullException_Test() =>
		DecryptAsync_NullEncryptedData_ShouldThrowArgumentNullException();

	[Fact]
	public Task DecryptAsync_UnsupportedAlgorithm_ShouldThrowEncryptionException_Test() =>
		DecryptAsync_UnsupportedAlgorithm_ShouldThrowEncryptionException();

	[Fact]
	public Task DecryptAsync_SuspendedKey_ShouldThrowEncryptionException_Test() =>
		DecryptAsync_SuspendedKey_ShouldThrowEncryptionException();

	[Fact]
	public Task DecryptAsync_NonExistentKey_ShouldThrowEncryptionException_Test() =>
		DecryptAsync_NonExistentKey_ShouldThrowEncryptionException();

	#endregion Decrypt Tests

	#region Round-Trip Tests

	[Fact]
	public Task RoundTrip_EncryptDecrypt_ShouldReturnOriginalPlaintext_Test() =>
		RoundTrip_EncryptDecrypt_ShouldReturnOriginalPlaintext();

	[Fact]
	public Task RoundTrip_TextData_ShouldPreserveContent_Test() =>
		RoundTrip_TextData_ShouldPreserveContent();

	[Fact]
	public Task RoundTrip_AfterKeyRotation_ShouldStillDecrypt_Test() =>
		RoundTrip_AfterKeyRotation_ShouldStillDecrypt();

	#endregion Round-Trip Tests

	#region ValidateFipsCompliance Tests

	[Fact]
	public Task ValidateFipsComplianceAsync_ShouldReturnBoolean_Test() =>
		ValidateFipsComplianceAsync_ShouldReturnBoolean();

	#endregion ValidateFipsCompliance Tests

	#region Disposable Tests

	[Fact]
	public Task Disposed_Provider_ShouldThrowObjectDisposedException_Test() =>
		Disposed_Provider_ShouldThrowObjectDisposedException();

	#endregion Disposable Tests
}
