// SPDX-FileCopyrightText: Copyright (c) 2026 The Excalibur Project
// SPDX-License-Identifier: LicenseRef-Excalibur-1.0 OR AGPL-3.0-or-later OR SSPL-1.0 OR Apache-2.0

using Excalibur.Dispatch.Compliance;

using Microsoft.Extensions.DependencyInjection;

namespace Excalibur.Dispatch.Compliance.Tests.Configuration;

[Trait("Category", "Unit")]
[Trait("Component", "Compliance")]
public sealed class ComplianceServiceCollectionExtensionsShould
{
	[Fact]
	public void RegisterEncryptionServicesWithDefaults()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act
		services.AddComplianceEncryption();

		// Assert
		var provider = services.BuildServiceProvider();
		var keyMgmt = provider.GetService<IKeyManagementProvider>();
		var encryption = provider.GetService<IEncryptionProvider>();
		var fipsDetector = provider.GetService<IFipsDetector>();
		var fipsValidation = provider.GetService<FipsValidationService>();

		keyMgmt.ShouldNotBeNull();
		encryption.ShouldNotBeNull();
		fipsDetector.ShouldNotBeNull();
		fipsValidation.ShouldNotBeNull();
	}

	[Fact]
	public void RegisterEncryptionServicesWithCustomKeyManagement()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();
		var configCalled = false;

		// Act
		services.AddComplianceEncryption(
			configureKeyManagement: opts => { configCalled = true; opts.AutoGenerateDefaultKey = true; });

		// Assert
		configCalled.ShouldBeTrue();
		var provider = services.BuildServiceProvider();
		provider.GetService<IKeyManagementProvider>().ShouldNotBeNull();
	}

	[Fact]
	public void RegisterEncryptionWithRotation()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act
		services.AddComplianceEncryptionWithRotation(
			configureKeyManagement: opts => opts.AutoGenerateDefaultKey = true);

		// Assert
		var provider = services.BuildServiceProvider();
		var encryption = provider.GetService<IEncryptionProvider>();
		encryption.ShouldNotBeNull();
		encryption.ShouldBeOfType<RotatingEncryptionProvider>();
	}

	[Fact]
	public void RegisterEncryptionWithCustomKeyManagementProvider()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act
		services.AddComplianceEncryption<InMemoryKeyManagementProvider>();

		// Assert
		var provider = services.BuildServiceProvider();
		provider.GetService<IKeyManagementProvider>().ShouldNotBeNull();
		provider.GetService<IEncryptionProvider>().ShouldNotBeNull();
	}

	[Fact]
	public void RegisterFipsValidationOnly()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act
		services.AddFipsValidation();

		// Assert
		var provider = services.BuildServiceProvider();
		provider.GetService<IFipsDetector>().ShouldNotBeNull();
		provider.GetService<FipsValidationService>().ShouldNotBeNull();
		provider.GetService<IEncryptionProvider>().ShouldBeNull();
	}

	[Fact]
	public void RegisterFipsValidationWithCustomDetector()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act
		services.AddFipsValidation<DefaultFipsDetector>();

		// Assert
		var provider = services.BuildServiceProvider();
		provider.GetService<IFipsDetector>().ShouldNotBeNull();
		provider.GetService<FipsValidationService>().ShouldNotBeNull();
	}

	[Fact]
	public void ThrowWhenServicesIsNull_AddComplianceEncryption()
	{
		IServiceCollection? services = null;
		Should.Throw<ArgumentNullException>(() => services!.AddComplianceEncryption());
	}

	[Fact]
	public void ThrowWhenServicesIsNull_AddComplianceEncryptionWithRotation()
	{
		IServiceCollection? services = null;
		Should.Throw<ArgumentNullException>(() => services!.AddComplianceEncryptionWithRotation());
	}

	[Fact]
	public void ThrowWhenServicesIsNull_AddFipsValidation()
	{
		IServiceCollection? services = null;
		Should.Throw<ArgumentNullException>(() => services!.AddFipsValidation());
	}

	[Fact]
	public void RegisterMultiRegionKeyManagementWithTypeParameters()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act
		services.AddMultiRegionKeyManagement<InMemoryKeyManagementProvider, InMemoryKeyManagementProvider>(
			options =>
			{
				options.Primary = new RegionConfiguration
				{
					RegionId = "us-east-1",
					Endpoint = new Uri("https://kms.us-east-1.example.com")
				};
				options.Secondary = new RegionConfiguration
				{
					RegionId = "eu-west-1",
					Endpoint = new Uri("https://kms.eu-west-1.example.com")
				};
			});

		// Assert
		var provider = services.BuildServiceProvider();
		var multiRegion = provider.GetService<IMultiRegionKeyProvider>();
		multiRegion.ShouldNotBeNull();
	}

	[Fact]
	public void ThrowWhenPrimaryRegionIsNull_MultiRegion()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act & Assert
		Should.Throw<ArgumentException>(() =>
			services.AddMultiRegionKeyManagement<InMemoryKeyManagementProvider, InMemoryKeyManagementProvider>(
				_ => { }));
	}

	[Fact]
	public void ThrowWhenSecondaryRegionIsNull_MultiRegion()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();

		// Act & Assert
		Should.Throw<ArgumentException>(() =>
			services.AddMultiRegionKeyManagement<InMemoryKeyManagementProvider, InMemoryKeyManagementProvider>(
				options =>
				{
					options.Primary = new RegionConfiguration
					{
						RegionId = "us-east-1",
						Endpoint = new Uri("https://kms.us-east-1.example.com")
					};
				}));
	}

	[Fact]
	public void RegisterMultiRegionKeyManagementWithFactories()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();
		var primaryFactory = A.Fake<IKeyManagementProvider>();
		var secondaryFactory = A.Fake<IKeyManagementProvider>();

		// Act
		services.AddMultiRegionKeyManagement(
			options =>
			{
				options.Primary = new RegionConfiguration
				{
					RegionId = "us-east-1",
					Endpoint = new Uri("https://kms.us-east-1.example.com")
				};
				options.Secondary = new RegionConfiguration
				{
					RegionId = "eu-west-1",
					Endpoint = new Uri("https://kms.eu-west-1.example.com")
				};
			},
			(_, _) => primaryFactory,
			(_, _) => secondaryFactory);

		// Assert
		var provider = services.BuildServiceProvider();
		provider.GetService<IMultiRegionKeyProvider>().ShouldNotBeNull();
	}

	[Fact]
	public void RegisterKeyRotation()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();
		services.AddComplianceEncryption();

		// Act
		services.AddKeyRotation(opts => opts.CheckInterval = TimeSpan.FromHours(2));

		// Assert
		var provider = services.BuildServiceProvider();
		provider.GetService<IKeyRotationScheduler>().ShouldNotBeNull();
	}

	[Fact]
	public void RegisterKeyRotationWithoutOptions()
	{
		// Arrange
		var services = new ServiceCollection();
		services.AddLogging();
		services.AddComplianceEncryption();

		// Act
		services.AddKeyRotation();

		// Assert
		var descriptors = services.Where(d => d.ServiceType == typeof(IKeyRotationScheduler));
		descriptors.ShouldNotBeEmpty();
	}
}
